---
title: Next.js Setup
description: Use Commet SDK in Next.js applications
---

import { Steps, Step } from 'fumadocs-ui/components/steps'
import { Tabs, Tab } from 'fumadocs-ui/components/tabs'
import { Callout } from 'fumadocs-ui/components/callout'

# Next.js Setup

<Callout type="info">
**Requirements:** Next.js 13.4+
</Callout>

<Steps>
<Step>

## Install

<Tabs items={['npm', 'pnpm', 'yarn', 'bun']}>
<Tab value="npm">
```bash
npm install @commet/node @commet/next
```
</Tab>
<Tab value="pnpm">
```bash
pnpm add @commet/node @commet/next
```
</Tab>
<Tab value="yarn">
```bash
yarn add @commet/node @commet/next
```
</Tab>
<Tab value="bun">
```bash
bun add @commet/node @commet/next
```
</Tab>
</Tabs>

</Step>

<Step>

## Configure

```bash title=".env.local"
COMMET_API_KEY=your_api_key_here
COMMET_WEBHOOK_SECRET=your_webhook_secret
```

</Step>

<Step>

## Initialize

```typescript title="lib/commet.ts"
import { Commet } from '@commet/node'

export const commet = new Commet({
  apiKey: process.env.COMMET_API_KEY!,
  environment: 'sandbox',
})
```

</Step>
</Steps>

## Webhooks

```typescript title="app/api/webhooks/commet/route.ts"
import { Webhooks } from '@commet/next'

export const POST = Webhooks({
  webhookSecret: process.env.COMMET_WEBHOOK_SECRET!,
  onSubscriptionActivated: async (payload) => {
    // Grant access
    console.log('Activated:', payload.data.externalId)
  },
  onSubscriptionCanceled: async (payload) => {
    // Revoke access
    console.log('Canceled:', payload.data.externalId)
  },
})
```

## Customer Portal

```typescript title="app/api/commet/portal/route.ts"
import { CustomerPortal } from '@commet/next'
import { auth } from '@/lib/auth'

export const GET = CustomerPortal({
  apiKey: process.env.COMMET_API_KEY!,
  environment: 'sandbox',
  getCustomerId: async (req) => {
    const session = await auth.api.getSession({ headers: req.headers })
    return session?.user.id ?? null
  },
})
```

```tsx
<a href="/api/commet/portal">Manage Billing</a>
```

## Server Actions

```typescript title="app/actions/billing.ts"
'use server'

import { commet } from '@/lib/commet'

export async function trackUsage(eventType: string, externalId: string) {
  return commet.usage.track({
    eventType,
    externalId,
    idempotencyKey: `${externalId}_${Date.now()}`,
  })
}
```

## Related Resources

- [Node.js Setup](/docs/library/installation/node) - General setup
- [Usage Events](/docs/library/features/usage-events) - Track consumption
- [Portal Access](/docs/library/features/portal-access) - Portal details
